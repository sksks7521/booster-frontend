## 카카오맵 마커/클러스터 구현 가이드 (분석 페이지)

작성일: 2025-08-25

### 목적

- 다른 DB/프로젝트에서도 동일한 룰로 카카오맵 마커를 재사용할 수 있도록 디자인·로직·성능 정책을 표준화한다.

### 디자인 스펙 (현대적, 기능 불변)

- 크기: 25×25 px, 라운드 6px, 플랫 컬러 + 1px 헤어라인 보더(#00000020)
- 텍스트: 중앙 정렬, 12px, font-weight 600, 색상 #FFFFFF, system-ui 폰트 스택
- 앵커: 중심(center)

### 색상/라벨 규칙

- 색상(최저가 절대금액, 단위 만원):
  - t1=6000, t2=8000, t3=10000, t4=13000
  - ≤t1: blue(#2563eb), ≤t2: green(#16a34a), ≤t3: pink(#ec4899), ≤t4: orange(#f59e0b), >t4: red(#ef4444), 없음/0: grey(#64748b)
- 라벨(퍼센트 버킷): 최저가/감정가(%)를 10% 단위로 버킷팅 → "00"/"10"/.../"90"/"100"; 값 없음은 "--"

### 구현 요약

- 방식: Kakao `Marker` + `MarkerImage(SVG data URL)` 사용. `CustomOverlay` 대신 SVG 이미지 기반으로 DOM 오버헤드 최소화 및 클러스터러 100% 호환 확보.
- 캐시: 색상-라벨 조합별 SVG data URL을 메모이제이션(Map)하여 재사용.
- 접근성: `title`에 금액·퍼센트 버킷 정보를 포함.

### 클러스터 정책

- Kakao `MarkerClusterer` 사용.
- 줌 정책(권장): level ≥ 9 → 클러스터 병합, level 7–8 → 부분 병합, level ≤ 6 → 개별 마커.
- 대량(수천 개)에서도 안정적으로 동작하도록 클러스터러 우선 적용.

### 줌/중심 정책 업데이트 (2025-08-26)

- 지역 최초 진입 및 지역 변경 시 기본 줌 레벨을 8로 통일.
- 지역 전환 직후 데이터 로드 완료 타이밍에 맞춰 1회 `fitBounds` 보장(`pendingFitRef`).
- `fitBounds`/`setCenter` 직후 즉시 상태 동기화로 Idle 의존 레이스 완화.
- 좌측 좌표 오버레이에 현재 줌 `z=..` 표기(2자리 zero-padding).

### 초기 가시성

- 마커 생성 후 각 마커의 좌표로 `LatLngBounds`를 구성하여 `map.setBounds(bounds, 40, 40, 40, 40)` 호출.
- 선택 지역 진입 시 자동 센터링/적정 줌으로 사용자에게 즉시 가시화.
  - 현재 정책: `setBounds(..., padding)` 적용 후 `setLevel(8)`로 통일.

### 데이터 필드 요구사항

- 좌표: `latitude`, `longitude` (또는 `lat`, `lng` 폴백 지원)
- 표시값: `minimum_bid_price`(만원), `bid_to_appraised_ratio`(%) → 10% 버킷 변환
- 결측 처리: 최저가 없음/0 → grey, 퍼센트 없음 → "--"

### 지도/목록 정합성 정책 (2025-08-26)

- 지도 마커 데이터는 페이지 아이템이 아닌 ‘필터 적용 전체(mapItems)’를 사용.
- 목록은 페이지네이션 유지, 상단 ‘필터 N건’은 클라이언트 처리 결과와 동기.
- ‘설정 초기화’ 시 매각기일을 오늘~+1개월로 기본 세팅하여 즉시 필터 일치 보장.

### 성능/품질 노트

- `MarkerImage(SVG)`는 `CustomOverlay(HTML)` 대비 DOM 부하가 낮고, 클러스터와 호환됨.
- 이미지 캐시로 중복 데이터 URL 생성을 방지.
- 디바운스(200ms)로 줌/이동 이벤트 처리 빈도 제어.

### 환경 변수/설정

- `NEXT_PUBLIC_MAP_PROVIDER=kakao`
- `NEXT_PUBLIC_KAKAO_APP_KEY=...` (카카오 도메인 등록 필요)
- 임시 스펙: 색상 임계값(t1~t4)은 코드/ENV에서 상수로 관리 가능.

### 테스트 체크리스트

- 시도/시군구 선택 시: 마커 생성 → 자동 센터링/줌 적용 확인
- 줌 레벨 변화: ≥9 병합, 7–8 부분, ≤6 개별 동작 확인
- 결측 데이터: grey 배지 및 "--" 라벨 확인
- 접근성: 마커 `title` 툴팁에 텍스트 노출 확인

### 참고

- Kakao 지도 가이드: Custom Overlay/Marker/Clusterer 권장사항에 따름.
- 내부 구현 파일: `Application/components/features/map-view.tsx`

### 진행 현황 (250825)

- SVG 기반 `MarkerImage` 배지(25×25, 라운드 6px, 흰색 12px 라벨) 구현 완료
- 색상 규칙(t1=6000, t2=8000, t3=10000, t4=13000) 및 결측=grey 적용
- 라벨 규칙: 최저가/감정가 비율 10% 버킷(“00”~“100”, 결측 “--”) 적용
- Kakao `MarkerClusterer` 연동, 줌 정책: ≥9 병합, 7–8 부분, ≤6 개별, 디바운스 200ms
- 초기 가시성: 생성 마커 `LatLngBounds`로 `setBounds(..., 40,40,40,40)` 적용
- 데이터 필드: `latitude/longitude` 필수화, 폴백 `lat/lng` 지원
- 클릭 인터랙션: 상세 오픈 이벤트 디스패치 + 포커스 링 하이라이트
- MapView는 로딩/에러에서도 지도 유지하여 오버레이 렌더 지속 [[memory:7093571]]
- 지도/아이템 디버그 로그는 플래그로 게이팅 [[memory:7092739]]

### 팝업 구현 상세 (2025-08-23)

- 표시 필드: 감정가, 최저가, 최저가/감정가, 현재상태, 매각기일, 공시가격, 건물평형(평), 층확인, Elevator, 건축연도(년), 최저가/공시가격(%) , 특수조건(문자열 또는 불리언 플래그 조합).
- 레이아웃: 폭 고정 270px, 특수조건 줄바꿈 허용(white-space: normal, word-break: break-word).
- 상단 액션: 관심물건(☆/⭐), 공유(🔗). 주소/사건번호 복사 버튼은 도로명 주소 아래 좌측 정렬.
- 하단 액션: 닫기, 상세보기(중앙 정렬).
- 접근성: 금액/비율/날짜 셀에 aria-label.
- 토스트: 지도 컨테이너 기준 정하단 중앙, 3초 노출 후 페이드아웃.
- 중앙 정렬: 마커 클릭 시 Kakao 투영 → panBy(-dx,-dy) 정밀 보정. 투영 불가 시 panTo → setCenter 폴백.
- 상호작용: 팝업 내부 wheel/touchmove/click 버블 차단. 지도 배경 클릭/드래그/줌 자동 닫힘 비활성.
- ‘팝업 유지’ 기능은 사용자 요청으로 최종 삭제.

### 중앙 크로스헤어

- 화면 중앙에 SVG 크로스헤어(pointer-events:none)를 항상 표시. 중앙 정렬 보정 기준점으로 사용.

### 변경 기록 / 안정화 전략 (2025-08-25)

- 지도 컨테이너 유지: 로딩/에러 시 조기 return 제거, 지도 DOM은 항상 유지하고 상태는 오버레이로 표시.
- 리마운트 키 확장: `MapView`의 key를 `${sido}-${city}-${town}`로 확장하여 읍면동 단위 변경에도 안정 리마운트.
- 내부 초기화 트리거: `locationKey` prop 추가. 값 변경 시 마커/클러스터/팝업 정리, `didInitialFitRef=false`로 초기화.
- fitBounds 경합 방지: `pendingFitRef`로 지역 전환 직후에는 새 데이터 로드 완료 뒤에만 1회 `fitBounds` 수행. 이전 응답의 늦은 도착으로 센터가 틀어지는 현상 방지.
- 0건 폴백 보정: 0건일 때는 `relayout()`만 수행하고 현재 중심/레벨을 유지(임의 기준 좌표로 이동하지 않음).
- 중심 유지 정책: 최초 1회만 `fitBounds`, 이후 필터 변경에서는 현재 중심 유지 + `relayout()`.
- 포커스 하이라이트 제거: 마커 클릭 시 표시되던 파란 원형/핀 제거.
- 좌표 오버레이: 좌측 하단에 ‘좌표’ 카드(제목+중앙/마우스, 소수점 6자리). Kakao `idle`/`mousemove`로 갱신.
- SWR 보강: `keepPreviousData`, `dedupingInterval`, `revalidateOnFocus=false`, `revalidateOnReconnect=false`, `errorRetry` 등으로 레이스/깜빡임 완화.

검증 체크리스트(안정화)

- 지도 탭 상태에서 시/군/읍면동을 연속으로 변경해도 타일/마커 공백 없이 즉시 갱신된다.
- 빠른 전환 중에도 최종 선택 지역 기준으로 1회만 `fitBounds`가 적용되고, 이전 지역 응답으로 센터가 덮어씌워지지 않는다.
- 0건 지역에서도 지도의 현재 중심/줌이 유지된다.
- 마커 클릭 시 파란 링/핀 등 추가 하이라이트가 생성되지 않는다.
- 좌측 하단 ‘좌표’ 카드가 항상 표시되고, 마우스 이동/드래그/줌에 따라 값이 갱신된다.

### 다음 단계

- API 보장: `/api/v1/items/custom`에 `latitude/longitude` 필드 항상 포함 확인(서버 합의)
- ENV/도메인: `NEXT_PUBLIC_KAKAO_APP_KEY` 설정 및 카카오 도메인 등록 재확인
- 임계값 외부화: t1~t4를 `lib/map/config.ts` 또는 ENV로 분리(운영 조정)
- 클러스터 튜닝: `minLevel/gridSize` 지역별 트래픽에 맞춰 값 미세 조정
- 성능 검증: 5k+ 마커 샘플로 로드/줌/이동 시 프레임드랍 측정
- 접근성: 키보드 포커스 이동 시 마커 포커스 표시/ARIA 라벨 점검 강화
- 에러/로그: 지도 오류 경로에 대한 사용자 메시지/리트라이 UX 정리(디버그 플래그 유지)
- 문서화: 운영자가 색상 임계값과 버킷 규칙을 변경하는 절차 추가

### MapLegend 컴포넌트 설계 (카카오 전환 기준)

- 목적: 색상 구간(최저가, 단위 만원)과 마커 숫자 의미(10% 버킷)를 지도의 상태와 독립적으로 명확히 설명
- 위치/레이아웃: 지도 컨테이너 우상단 절대배치, 모바일 폭에서 접힘(toggle) 옵션
- 타이포그래피: system-ui, 12px 본문 / 13px 굵은 제목, 대비 비율 확보(텍스트 + 수치 병기)
- 색상칩: 12×12px, border-radius: 3px, 오른쪽에 수치 텍스트(≤ t1 … > t4)
- 내용 구조:
  - 제목: "최저가 범례(단위: 만원)"
  - 라인: `≤ 숫자 만원` 포맷으로 표기, 마지막 라인은 `> 숫자 만원` (구간 수 0일 때 `> 미설정`)
  - 칩 리스트: 구간 수(N)에 따라 N+1개 동적 생성. 표시 색은 팔레트(파랑/초록/분홍/주황/빨강) 순 매핑
  - 부가 설명: 네모박스 숫자 → 10% 버킷(예: 40 = 40~49%)
- 접근성: aria-label 제공, 각 항목은 숫자 포함 텍스트 대체 제공(색각 사용자 배려)
- 동적 갱신: Threshold 상태 변경 시 즉시 재계산. 비내림차순(t1 ≤ t2 ≤ …) 검증 후 반영
- 성능: 지도 이벤트와 무관한 React 고정 오버레이로 렌더, 비용 미미
- 인터페이스(요약):
  - 전역 상태: `thresholds: number[]`(길이 0~4), `palette: {blue, green, pink, orange, red}`
  - 내부: 구간 수 토글(0~4), 스와치 팝오버로 색상 선택, 1000 step 입력, 마지막 라인 `> … 만원`
  - 자동 제안: 구간 수를 늘릴 때 숫자는 최하단 값 기준 +5,000 간격으로 채움, 색상은 미사용 색에서 랜덤 추천

### 사용/운영 가이드

- 구간 수(0~4): 0이면 임계값 없이 `> 미설정`만 표시. 1~4는 N+1개 라인 표시
- 단위 표기: 라벨에 ‘만원’ 병기. 제목은 "최저가 범례(단위: 만원)"
- 색상 선택: 팝오버 스와치 7색(빨강/주황/노랑/초록/파랑/분홍/회색). 선택 시 링 강조
- 숫자 입력: 1000 step, 비내림차순 위반 시 확인 비활성화. 저장 시 범례/마커 즉시 반영
  - 사용: 분석 페이지 `map-view.tsx` 상단에서 상태(or 상수) 전달
- 스타일 가이드: 반투명 배경 `rgba(255,255,255,.92)`, 그림자 `0 1px 4px rgba(0,0,0,.08)`, 내부 여백 `8px`, 모서리 8px
