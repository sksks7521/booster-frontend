# v2 데이터셋 지역 필터링 문제 해결 가이드

## 📋 개요

v2 데이터셋(auction_ed, real_transactions, real_rents)에서 지역 선택 시 필터링이 작동하지 않는 문제의 해결 방법을 정리한 기술 가이드입니다.

**적용 대상**:

- 과거경매결과 (auction_ed) ✅ **해결 완료**
- 실거래가(매매) (real_transactions)
- 실거래가(전월세) (real_rents)

## 🚨 문제 증상

### **일반적인 증상**

- 사용자가 특정 지역(예: "경기도 고양시") 선택
- 전체 지역 데이터가 표시됨 (필터링 안됨)
- 데이터 개수가 전체 데이터셋 크기와 동일

### **진단 방법**

```javascript
// 브라우저 콘솔에서 확인
console.log("필터 상태:", filters);
console.log("API 파라미터:", filtersForQuery);
console.log("서버 응답 total:", result.total);
console.log("첫 번째 아이템 주소:", result.items?.[0]?.address);
```

## 🔍 문제 원인 분석

### **1. 프론트엔드 원인**

- **클라이언트 중복 필터링**: 서버 + 클라이언트에서 이중 필터링
- **좌표 필터링 충돌**: 지역 필터와 좌표 기반 필터가 동시 적용
- **필터 매핑 오류**: 프론트엔드 필터명과 백엔드 필드명 불일치

### **2. 백엔드 원인**

- **API 파라미터 미정의**: 엔드포인트에서 지역 필터 파라미터 누락
- **CRUD 전달 실패**: 필터 파라미터가 데이터베이스 쿼리로 전달되지 않음

## 🔧 해결 방법

### **Step 1: 프론트엔드 수정**

#### **A. 지역 필터 매핑 확인** (`Application/datasets/registry.ts`)

```typescript
// auction_ed 예시
if (filters?.province) {
  mappedFilters.address_area = filters.province;
  delete mappedFilters.province;
}
if (filters?.cityDistrict) {
  mappedFilters.address_city = String(filters.cityDistrict);
  delete mappedFilters.cityDistrict;
}

// real_transactions 예시 (백엔드 스키마에 따라 조정)
if (filters?.province) {
  mappedFilters.sido = filters.province;
  delete mappedFilters.province;
}
if (filters?.cityDistrict) {
  mappedFilters.sigungu = String(filters.cityDistrict);
  delete mappedFilters.cityDistrict;
}
```

#### **B. 클라이언트 필터링 설정** (`Application/components/features/[dataset]/[Dataset]SearchResults.tsx`)

```typescript
// 서버에서 모든 필터링을 지원하는 경우
const needsClientProcessing = false;

// 또는 조건부 설정
const needsClientProcessing = needsClientProcessing
  ? rawItems?.filter((item: any) => {
      /* 필터링 로직 */
    }) || []
  : rawItems || []; // 서버 데이터 그대로 사용
```

#### **C. 좌표 필터링 제거** (`Application/app/analysis/[id]/v2/page.tsx`)

```typescript
const queryFilters = {
  province: zFilters?.province,
  cityDistrict: zFilters?.cityDistrict,
  town: zFilters?.town,
  // 지역 필터만 사용하는 경우 좌표 관련 파라미터 제거
  // lat: centerAndRadius?.lat,
  // lng: centerAndRadius?.lng,
  // radius_km: centerAndRadius?.radius_km,
};
```

### **Step 2: 백엔드 협업**

#### **A. 요청서 작성 템플릿**

**파일명**: `Communication/Backend/send/Request/YYMMDD_Frontend_to_Backend_[데이터셋]_지역필터링_버그수정_요청.md`

**필수 포함 내용**:

```markdown
## 문제 상황

- API: /api/v1/[데이터셋]/
- 파라미터: address_area=경기도&address_city=경기도 고양시
- 현재 응답: 전체 데이터 반환
- 기대 응답: 해당 지역 데이터만 반환

## 재현 방법

1. 프론트엔드 URL 접속
2. 지역 선택
3. API 호출 확인

## 요청 사항

1. 엔드포인트에 지역 필터 파라미터 추가
2. CRUD로 필터 조건 전달
3. 테스트 케이스 검증

## 테스트 케이스

| 파라미터                                       | 기대 결과              |
| ---------------------------------------------- | ---------------------- |
| address_area=경기도&address_city=경기도 고양시 | 경기도 고양시 데이터만 |
| address_area=서울특별시                        | 서울특별시 전체 데이터 |
```

#### **B. 백엔드 수정 확인사항**

- API 엔드포인트에 지역 필터 파라미터 정의
- CRUD 함수로 필터 조건 전달
- SQL WHERE 절에 지역 조건 적용

### **Step 3: 검증 및 테스트**

#### **A. API 직접 테스트**

```bash
# cURL 테스트
curl -G "http://127.0.0.1:8000/api/v1/[데이터셋]/" \
  --data-urlencode "address_area=경기도" \
  --data-urlencode "address_city=경기도 고양시" \
  --data-urlencode "page=1" \
  --data-urlencode "size=20"
```

#### **B. 브라우저 테스트**

```javascript
// 브라우저 콘솔에서 실행
fetch(
  "http://127.0.0.1:8000/api/v1/[데이터셋]/?address_area=" +
    encodeURIComponent("경기도") +
    "&address_city=" +
    encodeURIComponent("경기도 고양시") +
    "&page=1&size=20"
)
  .then((r) => r.json())
  .then((d) => {
    console.log("total:", d.total);
    console.log("첫 번째 아이템:", d.items?.[0]);
  });
```

#### **C. 검증 체크리스트**

- [ ] 네트워크 요청에서 올바른 파라미터 전달 확인
- [ ] API 응답에서 필터링된 데이터만 반환 확인
- [ ] 첫 번째 아이템의 주소가 선택한 지역과 일치 확인
- [ ] 총 데이터 개수가 합리적인 범위 확인
- [ ] 페이지네이션 정상 작동 확인

## 📊 데이터셋별 필드 매핑

### **auction_ed (과거경매결과)**

```typescript
// 프론트엔드 → 백엔드
province → address_area
cityDistrict → address_city
town → eup_myeon_dong
```

### **real_transactions (실거래가 매매)**

```typescript
// 백엔드 스키마 확인 후 업데이트 필요
province → sido (추정)
cityDistrict → sigungu (추정)
town → admin_dong_name (추정)
```

### **real_rents (실거래가 전월세)**

```typescript
// 백엔드 스키마 확인 후 업데이트 필요
province → sido (추정)
cityDistrict → sigungu (추정)
town → admin_dong_name (추정)
```

## 🚨 주의사항

### **개발 시 주의점**

1. **필드명 확인**: 각 데이터셋의 백엔드 스키마에 따라 필드명이 다를 수 있음
2. **데이터 형식**: 지역명의 정확한 형식 확인 (예: "경기도 고양시" vs "고양시")
3. **성능 고려**: 클라이언트 필터링 비활성화로 서버 부하 증가 가능성

### **테스트 시 주의점**

1. **캐시 무효화**: 브라우저 캐시나 SWR 캐시로 인한 이전 결과 표시 가능
2. **다양한 지역 테스트**: 여러 지역에서 정상 작동 확인
3. **엣지 케이스**: 지역명에 특수문자나 공백이 포함된 경우 테스트

## 📚 참고 자료

### **관련 파일들**

- `Application/datasets/registry.ts`: 데이터셋 설정 및 필터 매핑
- `Application/components/features/[dataset]/[Dataset]SearchResults.tsx`: 검색 결과 컴포넌트
- `Application/app/analysis/[id]/v2/page.tsx`: v2 페이지 필터 설정
- `Communication/Backend/receive/Request/250830_Backend_to_Frontend_*_스키마_공유_및_예시_응답.md`: 백엔드 스키마 문서

### **성공 사례**

- **auction_ed**: 2025-09-01 해결 완료
  - 문제: 99,075개 → 해결: 2,651개 (경기도 고양시)
  - 참고: `Log/250901.md`

---

**작성일**: 2025-09-01  
**최종 업데이트**: 2025-09-01  
**Frontend Team**
