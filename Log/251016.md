## 2025-10-16 작업 로그 (RENT/Sale v2)

### 요약

- 전월세 영역 안만 보기 파이프라인 정리(영역 소스 우선), 표시N/총T 통일, /map 응답 표준화, fetch limit 분리.
- 엘리베이터 필터 UI/표시 바 정합(표준키 Y/N/all) 및 활성 표시 수정.
- /area 422 및 전월세 스키마 불일치 이슈를 백엔드 요청서로 정리.
- 초기 화면 기본 정렬 제거(계약일 컬럼 파란색 해제).

### 프론트엔드 변경

- RENT 파이프라인
  - `RentSearchResults.tsx`
    - applyCircle ON 시 소스 단일화: `/area` 우선, 실패 시 `/map` KNN 폴백.
    - fetch limit 분리: 요청키에서 cap 제거, applyCircle ON일 때 서버 limit=1000 고정.
    - 표시 요약: 지도/통합 탭에 “표시 N / 총 T” 표기(총 T=영역 총합 우선).
    - /map 응답을 `datasetConfigs['rent'].adapter.toItemLike`로 표준화 후 전역 소스 주입.
    - /area(list/server) 요청·응답 로그, echo, KNN 검증(top5) 로깅 추가(디버그 게이트).
    - /area 리스트/지도 요청은 `ordering=distance` 고정(목록 정렬은 클라에서 처리) → 422 회피.
    - `mapTotal` 참조 순서 오류 수정(ReferenceError 제거).
    - 초기 기본 정렬 useEffect 제거(초기 정렬 없음).
- RENT 빌더/맵 페이로드/영역 파라미터
  - `buildRentFilterParams.ts`
    - floorTokenMode 허용값(en/eng/kr) 보강, 주소검색 필드 확장(road|road_address|jibun|jibun_address|both).
    - 날짜 별칭 `date_from/to` 병행, rent_type=all 미전송, floor_type 별칭 병행.
  - `components/features/rent/mapPayload.ts` → floorTokenMode: "en" 유지.
  - `components/features/rent/areaQuery.ts` → floorTokenMode: "en" 유지.
- 엘리베이터 UI/선택 바
  - `RentFilter.tsx`
    - 버튼 값/활성 기준을 문자열 표준키로 변경: 전체=all, 있음=Y, 없음=N.
  - `selected-filter-bar.tsx`
    - `elevatorAvailable`를 우선 표시(없으면 `hasElevator` 하위호환).

### 백엔드 요청서 작성/갱신

- `Communication/Backend/send/251016_Frontend_to_Backend_real-transactions-area-422-REQUEST.md`
  - /area 422 재현 URL, 좌표/반경 호환(center_lat/lng/radius_m ↔ lat/lng/radius_km), ordering=distance 기본, limit 힌트 수용, total/echo 명시.
- `Communication/Backend/send/251016_Frontend_to_Backend_real-rents-area-map-consistency-REQUEST.md`
  - /map·/area 필터/정렬/총계 일관성, 공통 키/별칭 수용 요청.
- `Communication/Backend/send/251016_Frontend_to_Backend_real-rents-area-schema-REQUEST.md`
  - dataset=rent 수용 또는 `/real-rents/area` 도입, 전월세 전용 컬럼(보증금/월세/전환금 등)과 simple 키(lat/lng/address/area/build_year/price) 반환 요청.

### 이슈 및 해결

- [해결] applyCircle ON에서 "표시 상한" 변경이 총합에 영향 → fetch limit 분리로 독립.
- [해결] 지도 "지도 total" 표기 불일치 → “표시 N / 총 T” 통일 및 영역 총합 사용.
- [해결] /map 응답 키 미정규로 목록 공란 → 어댑터 표준화 후 주입.
- [해결] 엘리베이터 버튼 활성/선택바 미표시 → 표준키(Y/N/all) 정합 및 UI/바 로직 수정.
- [해결] `mapTotal` 선언 순서 에러 → 계산 블록 위치 조정.
- [임시회피] /area 422 → ordering=distance 고정 요청 + 프론트 고정 적용.
- [원인확인] /area가 매매성 키 반환 → 백엔드에 전월세 스키마 수용 요청서 발송.

### 검증 체크(샘플)

- 영역 ON: 원 반경 1km, 표시상한 100/300/500 변경 → 총 T 불변, N만 변경.
- 전월세 필터(보증금/월세/전환금/기간/층확인/엘베/주소) 조합 시 목록·지도 동시 감소.
- 엘리베이터 버튼 클릭 시 즉시 파란색 활성, 선택된 필터 바 “엘리베이터: 있음/없음” 노출.
- 초기 진입 시 어떤 컬럼도 정렬 표시 없음(사용자 클릭 시에만 정렬).

### 다음 액션

- 백엔드 회신 후 `/area` 스키마/echo 확정에 맞춰 어댑터/요청 파라미터 최종 동기화.
- RENT 종합 테스트(rent-10): 영역/상세/정렬 조합, 총계 일치 최종 확인.

### 배포/SEO · Next.js 빌드 안정화

- 메타데이터 구조 정리(App Router 규칙 준수)

  - 클라이언트 컴포넌트에서 `export const metadata/generateMetadata` 제거.
  - 다음 경로에 `head.tsx` 도입: `/`(home), `/analysis`, `/analysis/[id]`, `/analysis/[id]/v2`(noindex), `/pricing`, `/support`, `/terms`, `/privacy`, `/login`(noindex), `/signup`(noindex), `/forgot-password`(noindex), `/checkout`(noindex), `/calculator`(noindex), `/favorites`(noindex), `/mypage`(noindex).
  - `/analysis/[id]` 동적 메타는 `app/analysis/[id]/head.tsx`로 이전.

- noindex 정책 반영(페이지 레벨)

  - 비노출: 로그인/회원가입/비밀번호찾기/결제/마이페이지/관심/계산기/상세분석 v2.
  - 노출: 홈/분석/요금제/공지/지원/개인정보/약관.

- 빌드 에러 해결

  - `pricing/page.tsx`: `"use client"` 최상단으로 이동, 메타 head로 이전.
  - `not-found.tsx`: `onClick` 사용을 위해 클라이언트 컴포넌트로 전환(`"use client"`).
  - `analysis/login/checkout`의 `useSearchParams`는 기존에 Suspense 처리 완료(재확인).

- 로봇/사이트맵

  - 전역 `robots.ts`는 Allow 기준 유지, 비노출 경로는 각 페이지 `head.tsx`에서 `meta robots`로 제어.
  - `sitemap.ts`: 코어 경로 노출 유지(홈/분석/요금제/로그인/결제 등) — 필요 시 조정 가능.

- 인프라 커뮤니케이션

  - 답신서 작성: `Communication/Infra/send/Response/251016_Frontend_to_Infra_Vercel_배포현황_ENV_정리_및_후속요청.md`
  - 요청 사항 요약: `NEXT_PUBLIC_SITE_URL` 설정, Supabase ENV 스코프 분리, 빌드 설정 점검, 프리뷰 보호(보류).

- 커밋 로그(요지)
  - fix(next): move metadata from client pages to head.tsx; add noindex via head for calc/checkout/analysis v2; fix Header usage
  - fix(next): move remaining client-page metadata to head.tsx (home/notices/favorites/mypage/forgot-password)
  - fix(next): remove metadata from client pages and add head.tsx (pricing/privacy/support/terms/signup); move 'use client' to top in pricing
  - fix(next): make not-found a client component to allow onClick handler
  - chore(infra): add infra reply to Infra team
