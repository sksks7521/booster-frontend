# 2025-09-09 작업 로그

### 개요

- **대상**: v2 경매결과(auction_ed) 및 향후 실거래가(sale), 전월세(rent), 매물(listings)
- **주요 이슈**: 영역 안만 보기 + 상세필터 조합 시 결과 개수 왜곡, 정렬/반경 토글 시 total 출렁임

### 증상 정리(대표 사례)

- 영역 내 총 35건인데, 엘리베이터 있음=17, 없음=50으로 표시(합이 전체를 초과)
- 건축면적 구간 0~20평=42, 20~100평=8 → 합이 정확히 50으로 고정
- 정렬 오름차순에서 개수 증가 후, 내림차순 전환 시 기존 수치로 복귀
- 반경 2000m에서는 작게, 5000m에서는 크게(예: 290) 출력

### 원인 진단(핵심)

- **서버 응답 일관성 문제**: 일부 상세필터(불리언/라벨·코드, 면적/상태 조합 등)에서 서버가 요청 `size`를 존중하지 못하거나(기본 50 cap), 전달 값 포맷을 기대대로 해석하지 못해 필터가 무시됨 → "부분 집합(주로 50)"만 반환되는 구간 발생
- **클라이언트 영역 필터 구조적 특성**: 영역(원/반경) 필터는 프런트에서 "마지막 단계"로 적용됨. 서버가 잘린 집합을 반환할 경우, 그 축소된 집합을 母집합으로 반경 필터를 적용하므로 합계/구간 수치가 왜곡됨
- **전역수집 모드 차이**: 정렬 on 시 여러 페이지를 모으는 전역수집을 사용, off 시 페이지 단위 집합 사용 → 시점에 따라 母집합이 바뀌어 숫자 출렁임 유발

### 결정 사항(방향성)

- 영역(원/반경) 필터링을 **서버에서 처리**하도록 전환(정확도/일관성 우선)
- 상세필터 값 **포맷 표준화**(불리언/라벨 → 서버 코드값)로 서버 필터링 100% 일관화
- 프런트는 **결과 표시**와 상호작용만 담당(정렬/리페이징 포함 서버 처리)
- **기능 플래그**로 점진 전환, 안정화 후 클라이언트 영역 필터 제거

### 구현 단계(순서)

1. API 규격 확정(공통)

   - 지오 파라미터: `center_lat`, `center_lng`, `radius_m`(또는 `south, west, north, east`)
   - 상세필터: 지역/가격/면적/연식/엘리베이터/층확인/현재상태/특수권리/검색
   - 정렬/페이지: `ordering`, `page`, `size`(최대치 명시), `total` 일관 반환
   - 값 포맷: 불리언/라벨 → 코드값(Y/N, O/X 등), 다중선택은 콤마 조인

2. 공간 인덱스/스키마 준비(백엔드)

   - 좌표 컬럼(Point, SRID 4326), GIST 인덱스 구축
   - 기존 lat/lng 백필 → geometry 변환
   - 쿼리: 원= `ST_DWithin(geom::geography, ST_MakePoint(lng,lat)::geography, radius_m)`
     박스= `geom && ST_MakeEnvelope(w, s, e, n, 4326)`

3. 백엔드 필터 파이프라인 공통화

   - 파라미터 검증, 라벨→코드 매핑, 필터 AND 조합
   - 적용 순서: 공간필터 → 상세필터 → 정렬 → 페이지네이션
   - `page/size/total` 일관 보장(임의 cap 금지, `max_size` 가드만 적용)

4. 데이터셋별 엔드포인트 확장

   - `auction_ed`, `real-transactions`, `real-rents`, `listings` 모두 동일 규격 지원
   - 정렬 키 매핑(camel→snake) 유지, 누락/unknown 값 허용 규칙 정리

5. 프런트 연동 변경

   - 영역 안만 보기 ON 시 서버로 `center_lat/lng + radius_m`(또는 bounds) 전송
   - 클라이언트 원/반경 필터 비활성(중복 필터 금지)
   - 상세필터 값은 서버 코드값으로 매핑해 전송
   - 서버 응답 `results/total`을 그대로 표시(정렬/리페이징 포함)

6. 기능 플래그/폴백

   - 데이터셋별 플래그: 서버 영역필터 사용 on/off
   - 서버 오류/비정상 total 감지 시 즉시 클라이언트 경로로 폴백

7. 테스트/검증 시나리오

   - 합계 일관성: 엘리베이터 있음+없음 = 영역 전체
   - 구간 합계: 0~20평 + 20~100평 = 영역 전체
   - 정렬 asc↔desc/반경 2000↔5000 토글 시 total 불변(동일 조건)
   - `page/size` 요청값 준수, 대용량 성능, 타임아웃/에러 처리

8. 모니터링/문서화

   - 쿼리 로그/메트릭, 슬로우 쿼리 추적, 에러율/지연 p95 모니터링
   - API 스펙/코드값 표/운영 가이드 문서화

9. 롤아웃 & 제거 기준
   - 내부→점진 배포, 이슈 0건/지표 안정 시 프런트 영역 필터 제거
   - 제거 조건: 합계 일관성 100%, 50개 고정 현상 미발생, 성능/오류율 기준 충족

### 즉시 액션 아이템

- 백엔드: API 파라미터/코드값 표 합의, 지오쿼리/인덱스 설계 착수
- 프런트: 기능 플래그 추가, 서버 방식 우선 사용 연동, 폴백 경로 유지
- QA: 합계/구간/정렬/반경/페이지 케이스 체크리스트 실행

### 완료 정의(DoD)

- 동일 조건에서 합계·구간·정렬·반경·페이지 변동에도 결과 일관
- 서버 응답의 `total/page/size`가 항상 요청/조건과 일치
- 사용자 리포트 0건, 모니터링 지표 정상 범위 유지 후 프런트 영역 필터 제거

### 변경/참고 사항(요약)

- 백엔드 엔드포인트: `GET /api/v1/auction-completed/area` (영역 ON 시 사용)
- 필수 파라미터: `center_lat`, `center_lng`, `radius_m`
- 지역 매핑: `province→sido`, `cityDistrict→address_city`, `town→eup_myeon_dong`
- 범위/날짜/연식:
  - 가격: `price_min/max`(만원)
  - 건축면적: `area_min/max`(평 기준)
  - 건축년도: `build_year_min/max`
  - 매각기일: `date_from/to`(YYYY-MM-DD) 또는 `saleYear`
- 전용 필터:
  - 엘리베이터: `elevator_available=Y|N`(서버 내부 O/X 매핑)
  - 층확인 CSV: 라벨 매핑 규칙(예: `지하→반지하`, `저층→일반층`, `1층→1층`, `일반층→일반층`, `탑층→탑층`, `확인불가→확인불가`, `반지하(직입력)→반지하`)
  - 현재상태 CSV: 권장 저장값(잔금납부, 매각, 변경, 취하, 기각, 각하, 배당종결, 기타, 대금미납, 미진행, 불허, 항고, 정지, 재매각, 유찰, 신건) + 별칭 매핑(`낙찰|sold→매각`, `failed→유찰`, `changed→변경`, `resale→재매각`, `new→신건`, `재진행→재매각/미진행`)
  - 특수권리/특수조건: 불리언 컬럼 키(`tenant_with_opposing_power`, `hug_acquisition_condition_change`, `senior_lease_right`, `re_auction`, `equity_sale`, `joint_collateral`, `separate_registration`, `lien_right`, `illegal_building`, `lease_sale`, `land_rights_unregistered`)는 True 매칭, 키워드(예: `관련사건, 우선매수권, 임차보증금, 압류, 가압류, 가처분, 소액임차권, 담보신탁, 용도제한`)는 텍스트 부분일치(OR)
- CSV 처리 규칙: 콤마 구분, 양끝 트리밍, 빈 토큰 무시, 상태/권리/검색 값은 대소문자 무시(ilike)
- 정렬/페이징: `ordering` 허용키(`sale_date`, `final_sale_price`, `bidder_count`, `construction_year`), `page`, `size≤1000`(임의 cap 없음)
- 품질 보장: 정렬 토글 시 `total` 불변, 반경 확대 시 `total` 단조 증가
- 구현 메모: 서버 v1은 BBOX+Haversine로 운영 반영(PostGIS 전환은 인프라 일정 확정 후 진행 가능)

### 1단계(기능 플래그) 사전 참고

- 목적: 기능 플래그만 추가(기본 OFF)하여 배포 시 동작 변화 없음 보장
- 환경 변수: `NEXT_PUBLIC_AUCTION_ED_SERVER_AREA=0` (기본 OFF)
- 플래그 리더: `lib/featureFlags.ts`에 `auctionEdServerAreaEnabled` 추가
- 배선(참조만, 분기 미적용):
  - `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`에서 플래그 읽기만 추가
  - `Application/datasets/registry.ts`에 `/area` 엔드포인트 상수 정의(참조)
- 다음 단계에서(플래그 ON + 영역 ON): `/area`로 전환, 파라미터 매핑 적용, 클라이언트 반경 필터 비활성, 폴백 유지

### 현재 상황과 조치 계획 (영역 모드 UI 불일치)

- 현재 상황

  - within=1에서 서버 `GET /api/v1/auction-completed/area`는 200 OK로 정상 호출됨(전환/플래그/가드 적용 완료).
  - UI가 일부 클라이언트 소스(로컬 파이프라인)를 참조하여 헤더/목록/빈 상태가 서버 결과와 불일치.
  - 엘리베이터 키 혼재(`elevatorAvailable` vs `hasElevator`)로 표시·매핑 어긋남 가능성.

- 조치 계획(순차 진행)

  1. ViewState 게이트를 서버 결과 기준으로 전환

     - 대상: `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`
     - 내용: `isLoading/error/total` 및 빈 상태 판단용 `items`를 `useServerArea ? serverAreaState.* : 기존값`으로 스위치
     - 기대 결과: 영역 토글 직후 목록 사라짐 현상 해소, 로딩/빈 상태 표기가 서버 응답 기준으로 일관

  2. 헤더 카운트(effectiveTotal) 일원화

     - 내용: 카운트 계산을 `effectiveTotal`로 통일 (`useServerArea` 시 `serverAreaState.total` 사용)
     - 기대 결과: 헤더 1건 vs 지도 20건 등 불일치 제거

  3. 목록/통합 탭 테이블 데이터 소스 전환

     - 내용: `ItemTable`의 `items`를 `useServerArea ? serverAreaState.items : 기존 pagedItems`로 전환
     - 기대 결과: 통합 탭에서 지도·목록 동일 집합 반영(목록 1건 문제 해소)

  4. 엘리베이터 키 단일화 및 매핑 일치
     - 내용: `hasElevatorUnified = hasElevator ?? elevatorAvailable` 단일 변수로 헤더/판정/쿼리 매핑 사용
     - 기대 결과: 있음/없음 토글 시 헤더·목록·지도 동기화, `/area?...elevator_available=Y|N` 일관

- 검증 방법

  - within=1에서 헤더/지도/목록 총건수 동일
  - 엘리베이터 있음/없음 토글 시 세 영역 동기 변동
  - 정렬/페이지 이동 시 `/area?...&ordering=...&page=...`만 호출되고 동일 조건에서 `total` 불변

- 진행 상태
  - 1. ViewState 게이트 전환: 적용 예정(1순위)
  - 2. 헤더 카운트 일원화: 대기
  - 3. 테이블 소스 전환: 대기
  - 4. 엘리베이터 키 단일화: 대기

### 1) ViewState 게이트 전환 - 적용/검증

- 적용 파일: `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`
  - `viewIsLoading`, `viewError`, `itemsForEmpty`, `viewTotal` 도입
  - `<ViewState>` 전달값을 `useServerArea` 활성 시 `serverAreaState` 기준으로 스위치
- 정적 검사: lints 0건
- 수동 검증(영역모드 within=1):
  - 목록 공백 현상: 재현 안 됨(해결)
  - 로딩/빈 상태: 서버 응답 기준으로 정상 노출
  - 잔여 문제: 헤더 건수, 통합 탭 목록이 서버 합계와 불일치(2·3단계 필요)
- 다음 작업: 2) 헤더 카운트(effectiveTotal) 일원화 진행

### 2) 헤더 카운트(effectiveTotal) 일원화 - 적용/검증

- 적용 파일: `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`
  - 헤더 영역의 "영역 안 필터" 카운트를 `processedItemsSorted.length` → `effectiveTotal`로 변경
  - `effectiveTotal`은 `useServerArea`일 때 `serverAreaState.total`을 사용함
- 정적 검사: lints 0건
- 수동 검증(영역모드 within=1):
  - 헤더의 "영역 안 필터" 건수가 지도/목록의 총합과 일치
  - 정렬/페이지 전환 시에도 동일 조건에서 헤더 총건수 불변
- 메모: 전체/지역/상세 카운트(왼쪽 헤더 3종)는 기존 로직 유지, 영역 모드에서는 사용자 주요 시선이 "영역 안 필터" 총건수이므로 우선 일치성 확보

### 3) 목록/통합 탭 테이블 소스 전환 - 적용/검증

- 적용 파일: `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`
  - 테이블 뷰: `<ItemTable items={useServerArea ? serverAreaState.items : pagedItems}>`
  - 통합 뷰(목록): 동일하게 `serverAreaState.items` 사용
- 정적 검사: lints 0건
- 수동 검증(영역모드 within=1):
  - 통합 탭에서도 지도와 목록이 동일 집합을 표시(이전의 목록 1건 문제 해소)
  - 페이지네이션/표시 범위 텍스트가 `effectiveTotal` 기준으로 정확

### 4) 영역 모드 지도 전용 대용량 페치 + 공통 쿼리 빌더 적용 (신규)

- 적용 파일:
  - `Application/components/features/auction-ed/areaQuery.ts` (신규): `/area` 공통 파라미터 빌더
  - `Application/components/features/auction-ed/AuctionEdSearchResults.tsx` (수정): 표/지도 이펙트 모두 공통 빌더 사용
- 내용:
  - 지도는 page=1, size=min(1000, BACKEND_MAX_PAGE_SIZE, MAP_GUARD.maxMarkers, UI상한)로 별도 대용량 요청(표는 20/50/100 유지)
  - 파리티 확보: 표/지도 모두 동일 파라미터 세트(지역/좌표/반경/가격/면적/연식/정렬/페이지/층확인/current_status/special_rights/검색/엘리베이터)
  - 가드: radius_m 500–10km, size≤1000, price_max 미만(<) 규칙
  - 엘리베이터: `has_elevator=true|false` + `elevator_available=Y|N` 병행 전송(서버 확정 전 호환)
- 결과:
  - within=1에서 지도 마커=총합(상한 내), 표=페이지 사이즈로 일관 표시
  - 지도 대용량 요청에도 `floor_confirmation/current_status/special_rights/search` 포함되어 버튼 변경 즉시 반영

### 5) 표 값 안전망 보강

- 적용 파일: `Application/components/features/auction-ed/AuctionEdSearchResults.tsx`
- 내용: 테이블 value resolver에 snake_case 폴백(`row[snake_case(key)]`) 추가 → 어댑터 누락 시 ‘-’ 최소화

### 6) 백엔드 문의(요청서) 발송 사항 요약

- /area에서 엘리베이터 필터 미적용 추정: `base=65`, `Y=0`, `N=65`, `has_elevator=true/false=65`
- 목록과 동일 파라미터 파리티 요청: 층확인/current_status/special_rights/검색/엘리베이터 키·값 확정 및 적용
- 수용기준: 동일 조건에서 목록/area 필터 결과 변화 확인, 정렬/페이지/반경 일관

### 진행 상태 업데이트

- 1. ViewState 게이트 전환: 완료
- 2. 헤더 카운트 일원화: 완료
- 3. 테이블 소스 전환: 완료
- 4. 엘리베이터 키 단일화: 다음 작업(진행 예정)
